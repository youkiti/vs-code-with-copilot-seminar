# 5. 解析プロジェクト演習

このセクションでは、実際の臨床研究を想定したデータセットを用いて、これまでに学んだスキルを活用した解析プロジェクトを行います。

## 目標

- データ解析の実践
- GitHubを使用したバージョン管理
- 解析結果のレポート作成

## 5.1 プロジェクトの進め方

### Step 1: 研究計画の立案

1. 研究目的の設定
   - 明確な研究課題の設定
   - 仮説の構築
   - 期待される成果の定義

2. 解析計画の作成
   - 必要なデータの特定
   - 統計手法の選択
   - 結果の評価方法の決定

### Step 2: データの準備と解析の流れ（AIがなかった時代）

#### コードの入力場所について

このプロジェクトでは、2種類のコード入力場所を使いわけます：

1. **Rのコード**：データの分析用
   - 拡張子が `.R` のファイルに書く
   - VS Codeで新しいファイルを作って保存
   - ファイル名の例：`analysis.R`

2. **ターミナルコマンド**：ファイル管理用
   - VS Code内の「ターミナル」で実行
   - メニューの「ターミナル」→「新しいターミナル」で開く
   - Windowsの場合は「Git Bash」を使用

#### データのダウンロードと保存

1. **最初に、新しいRファイルを作成します**
   - VS Codeで「ファイル」→「新規ファイル」
   - `analysis.R` という名前で保存

2. **以下のコードをRファイルに書きます**
```R
# GitHubからデータをダウンロード
download.file(
  "https://raw.githubusercontent.com/vscodejp/vs-code-with-copilot-seminar/main/data/patient_data.csv",
  "patient_data.csv"
)

# 現在の作業ディレクトリを確認
getwd()

# ファイルが存在するか確認
file.exists("patient_data.csv")

# CSVファイルを読み込む
data <- read.csv("patient_data.csv")

# データの中身を確認
head(data)  # 最初の6行を表示
str(data)   # データの構造を確認
summary(data)  # 基本統計量を確認
```

#### データ読み込みのトラブルシューティング

1. **ファイルが見つからないエラー**
```R
# エラーメッセージ例：
# Error in file(file, "rt") : cannot open the connection
# Error: cannot open file 'patient_data.csv': No such file or directory

# 解決方法：
# 1. 作業ディレクトリの確認
getwd()  # 現在の作業ディレクトリを表示
list.files()  # ディレクトリ内のファイル一覧を表示

# 2. 正しいディレクトリに移動
setwd("ファイルがある場所のパス")  # 作業ディレクトリの変更

# 3. フルパスで指定
data <- read.csv("C:/Users/あなたの名前/Documents/patient_data.csv")  # Windowsの例
data <- read.csv("/Users/あなたの名前/Documents/patient_data.csv")    # macOSの例
```

2. **文字化けの対処**
```R
# 文字化けの例：
# 性別が"男性"ではなく"??"と表示される

# 解決方法：
# 1. エンコーディングを指定して読み込み
data <- read.csv("patient_data.csv", fileEncoding = "UTF-8")  # UTF-8の場合
data <- read.csv("patient_data.csv", fileEncoding = "CP932")  # Shift-JISの場合

# 2. 読み込み後に文字コードを変換
data$sex <- iconv(data$sex, from = "UTF-8", to = "CP932")
```

3. **データの確認と修正**
```R
# 1. 列名の確認
names(data)  # 列名の一覧表示

# 2. データ型の確認
str(data)    # 各列のデータ型を表示

# 3. 文字列を因子型に変換
data$sex <- as.factor(data$sex)
data$smoking <- as.factor(data$smoking)

# 4. 数値の確認
summary(data)  # 数値の範囲や欠損値を確認
```

#### データの整理

1. 欠損値の確認
```R
# 欠損値の数を確認
colSums(is.na(data))

```

2. 異常値の確認
```R
# 年齢の範囲を確認
range(data$age)

# 血圧の範囲を確認
range(data$sbp)  # 収縮期血圧
range(data$dbp)  # 拡張期血圧
```

### Step 3: 探索的データ解析

1. 記述統計
```R
# 基本統計量の算出
# グラフによる可視化
```

2. 仮説の検証
```R
# 統計検定
# 多変量解析
```

### Step 4: 結果のまとめ

1. 図表の作成
```R
# 結果を視覚的に表現
# 効果的なグラフの選択
```

2. レポートの作成
   - R Markdownを使用
   - 結果の解釈と考察
   - 限界点の検討

## 5.2 GitHubでの作業の記録と共有

プログラムを書いていると、途中で間違えたり、前の状態に戻りたくなったりすることがあります。また、チームで作業するときは、お互いの変更を共有する必要があります。GitHubを使うと、これらがとても簡単になります。

### GitHubとは？

GitHubは、プログラムの変更を記録して共有できるウェブサービスです。以下のようなことができます：

1. **変更を記録する**（コミット）
   - 写真を撮るように、プログラムの状態を記録できます
   - 「いつ」「誰が」「何を」変更したのかが分かります

2. **変更を共有する**（プッシュ＆プル）
   - プッシュ：自分の変更をみんなに共有する（LINEで写真を送るみたいなもの）
   - プル：みんなの変更を自分のパソコンに取り込む（LINEで送られた写真を保存するみたいなもの）

3. **みんなで同時に作業する**（ブランチ＆マージ）
   - ブランチ：別々の作業場所を作る（実験用のコピーを作るみたいなもの）
   - マージ：別々の作業を1つにまとめる（実験がうまくいったら本番に取り入れるみたいなもの）

### VS CodeでのGitHub操作方法

#### 1. 最初の設定

1. **GitHubに作業場所を作る**
   - VS Codeの左側にある「ソース管理」アイコン（分岐のマーク）をクリック
   - 「リポジトリの初期化」ボタンをクリック
   - これで作業の記録が始められます！

2. **変更を記録する（コミット）**
   - ファイルを変更すると、「ソース管理」に変更したファイルが表示されます
   - 変更したファイルの横の「+」をクリックして、記録する変更を選びます
   - 上部のメッセージ欄に「今日の作業：データの読み込みをしました」のように作業内容を書きます
   - チェックマークをクリックすると、選んだ変更が記録されます

#### 2. 変更を共有する

1. **自分の変更を共有する（プッシュ）**
   - 「ソース管理」で「変更の公開」をクリック
   - これで自分の変更がGitHubのウェブサイトに公開されます
   - チームのメンバーが見られるようになります

2. **みんなの変更を取り込む（プル）**
   - 「ソース管理」で「プル」をクリック（矢印が下向きのボタン）
   - これでみんなの最新の変更が自分のパソコンに取り込まれます

#### 3. 別々の作業をするとき（ブランチ）

1. **新しい作業場所を作る**
   - VS Code左下の「main」をクリック
   - 「新しいブランチを作成」を選択
   - 名前を付ける（例：「新機能の追加」）
   - これで元の作業を壊さず、安全に新しいことを試せます

2. **作業をまとめる（マージ）**
   - うまくいった変更を本番の作業に取り入れたいとき
   - VS Code左下のブランチ名をクリック
   - 「main」を選択して元の作業場所に戻る
   - 「ソース管理」で「ブランチのマージ」を選択
   - 取り入れたい作業のブランチを選ぶ

### こんなときどうする？

1. **間違えて変更してしまった**
   - 「元に戻す」ボタン（丸い矢印）をクリック
   - 前の記録まで戻れます

2. **他の人と同じファイルを変更した**
   - VS Codeが自動的に教えてくれます
   - どちらの変更を採用するか、または両方を活かすか選べます

3. **変更の履歴を見たい**
   - 「タイムライン」タブをクリック
   - いつ、誰が、何を変更したのかが分かります

このようにGitHubを使うと：
- 間違えても安心（前の状態に戻れる）
- チームで協力しやすい（変更を共有できる）
- 作業の記録が残る（何をしたか後で分かる）

## 5.3 サンプルプロジェクト：高血圧に関する横断研究（AIに助けてもらいながら進めましょう）

### 研究の目的
- 高血圧の有病割合を調査する
- 高血圧と関連する要因を特定する

### 解析コード例

1. **データの準備**
```R
# 必要なパッケージの読み込み
library(tidyverse)
library(gtsummary)

# データの読み込み
data <- read.csv("patient_data.csv")

# 高血圧の定義（収縮期血圧140以上または拡張期血圧90以上）
data <- data %>%
    mutate(hypertension = ifelse(sbp >= 140 | dbp >= 90, "あり", "なし"))
```

2. **記述統計**

#### Copilot Chatを使った記述統計の作成

Copilot Chatを使うと、より対話的に記述統計の分析を進めることができます。
以下のような手順で、チャットを使って分析を行います：

1. **Copilot Chatの起動**
   - VS Code左側の「GitHub Copilot」アイコンをクリック
   - または `Ctrl + Shift + i` （Macの場合は `Cmd + Shift + i`）

2. **基本的な表の作成**
   チャットに以下のように入力：
   ```
   BMIが22以上と未満で2群に分けて、以下の項目を比較する表をtbl_summary()を使って作成してください：
   - 年齢
   - 性別
   - 血圧（収縮期・拡張期）
   - 喫煙
   - 運動習慣
   
   数値は平均値と標準偏差、カテゴリは人数と割合（%）で表示してください。
   ```

3. **表の改善**
   提案されたコードを実行した後、さらに改善したい点があれば、続けてチャットで依頼：
   ```
   以下の点を改善してください：
   - 項目名を日本語に変更
   - 数値は小数点以下1桁まで表示
   ```

4. **より詳細な分析**
   さらに詳しい分析が必要な場合は、具体的な条件を指定：
   ```
   BMIを以下の4群に分けて比較してください：
   - 低体重（18.5未満）
   - 普通体重（18.5以上25未満）
   - 前肥満（25以上30未満）
   - 肥満（30以上）
   
   各群で以下を比較：
   - 平均年齢（±標準偏差）
   - 性別分布
   - 血圧値
   - 高血圧の割合
   ```

#### チャットのコツ

1. **分析の目的を明確に**
   ```
   医学論文用の表を作成したいので、以下の形式で出力してください：
   - 数値は平均値±標準偏差
   - パーセンテージは小数点以下1桁
   ```

2. **段階的に改善**
   ```
   1. まず基本的な比較表を作成
   2. 「表示形式を調整してください」
   3. 「統計量を追加してください」
   4. 「表示を日本語に変更してください」
   ```

3. **エラーが出たら**
   ```
   エラーメッセージをコピーして：
   「このエラーを解決する方法を教えてください。
   また、なぜこのエラーが起きたのかも説明してください」
   ```

このように、Copilot Chatを使うと、対話形式で分析を進められ、
エラーが発生しても即座に解決方法を聞くことができます。

3. **グラフ作成**

#### Copilot Chatを使ったグラフ作成

Copilot Chatを使うと、対話形式でグラフを作成し、カスタマイズできます。
以下のような手順で進めます：

1. **散布図の作成**
   チャットに以下のように入力：
   ```
   年齢と収縮期血圧の関係を示す散布図をggplot2で作成してください。
   以下の要件で作成をお願いします：
   - 性別で色分け
   - 回帰直線の追加
   - 軸ラベルは日本語
   - テーマはminimal
   ```

2. **グラフの改善**
   基本的なグラフができたら、さらに改善を依頼：
   ```
   以下の点を改善してください：
   - プロットの透明度を0.6に設定
   - 凡例の位置を下部に移動
   - 信頼区間を95%に設定
   - フォントサイズを大きく
   ```

3. **複雑なグラフの作成**
   より詳細なグラフが必要な場合：
   ```
   高血圧の有病率を示す棒グラフを作成してください：
   - 年齢層で区切る（50歳未満、50-65歳、65歳以上）
   - 性別でパネル分割
   - 割合（%）で表示
   - カラーパレットは青系統
   ```

#### グラフ作成のコツ

1. **基本設計を最初に伝える**
   ```
   医学論文用のグラフを作成したいので：
   - フォントは明朝体
   - 軸ラベルは日本語
   - 凡例は日本語
   - 解像度は300dpi
   ```

2. **段階的な改善**
   ```
   1. まず基本的なグラフを作成
   2. 「デザインを調整してください」
   3. 「統計情報を追加してください」
   4. 「保存用の設定を追加してください」
   ```

3. **出力形式の指定**
   ```
   このグラフを論文投稿用に保存したいので：
   - 幅を8インチ
   - 高さを6インチ
   - 解像度を300dpi
   - PDF形式で保存
   するコードを追加してください
   ```

このように、Copilot Chatを使うことで、対話的にグラフを作成・改善できます。
エラーが出た場合も、すぐに解決方法を聞くことができます。

4. **統計解析**

#### Copilot Chatを使った統計解析

Copilot Chatを使って、段階的に統計解析を進めることができます。
以下のような手順で分析を行います：

1. **基本的な統計解析**
   チャットに以下のように入力：
   ```
   高血圧の有無で2群に分けて、以下の項目を比較する統計解析を行ってください：
   - 年齢：t検定
   - 性別：カイ二乗検定
   - BMI：t検定
   - 喫煙：カイ二乗検定
   - 運動習慣：カイ二乗検定
   ```

   すると、以下のようなコードが提案されます：
   ```R
   # 高血圧群と非高血圧群の比較
   
   # 年齢の比較（t検定）
   t.test(age ~ hypertension, data = data)
   
   # 性別の比較（カイ二乗検定）
   chisq.test(table(data$sex, data$hypertension))
   
   # BMIの比較（t検定）
   t.test(bmi ~ hypertension, data = data)
   ```

   結果の例：
   ```
   # 年齢のt検定結果
   Welch Two Sample t-test
   
   data:  age by hypertension
   t = -8.5397, df = 456.61, p-value < 2.2e-16
   # → p値が0.05未満で、高血圧群と非高血圧群で年齢に有意差あり
   
   # 性別のカイ二乗検定結果
   Pearson's Chi-squared test
   
   X-squared = 15.683, df = 1, p-value = 7.492e-05
   # → p値が0.05未満で、性別と高血圧に関連あり
   ```

2. **多変量解析**
   チャットに以下のように入力：
   ```
   高血圧を目的変数として、以下の説明変数でロジスティック回帰分析を行ってください：
   - 年齢
   - 性別
   - BMI
   - 喫煙
   - 運動習慣
   
   オッズ比と95%信頼区間も計算してください。
   ```

   提案されるコード：
   ```R
   # ロジスティック回帰分析
   model <- glm(
       hypertension == "あり" ~ age + sex + bmi + smoking + exercise,
       family = binomial,
       data = data
   )
   
   # 結果の表示
   summary(model)
   
   # オッズ比と95%信頼区間の計算
   exp(cbind(OR = coef(model), 
             confint(model)))
   ```

   結果の例：
   ```
   Coefficients:
                Estimate Std. Error z value Pr(>|z|)    
   (Intercept)  -5.2345    0.7234  -7.235  4.65e-13 ***
   age           0.0534    0.0089   6.000  1.97e-09 ***
   sexMale       0.7234    0.2345   3.085  0.00204 ** 
   bmi           0.1234    0.0345   3.578  0.00035 ***
   
   # オッズ比と95%信頼区間
                   OR     2.5 %    97.5 %
   age          1.055    1.037     1.073  # 1歳上がるごとに1.055倍
   sexMale      2.061    1.302     3.267  # 男性は女性の2.061倍
   bmi          1.131    1.058     1.210  # BMI 1単位上がるごとに1.131倍
   ```

3. **結果の解釈**
   チャットに以下のように入力：
   ```
   上記の結果を医学論文の結果セクションで使える形式で解釈してください。
   統計的有意性（p値）とオッズ比（95%信頼区間）を含めて説明してください。
   ```

   すると、以下のような解釈が提案されます：
   ```
   多変量ロジスティック回帰分析の結果、以下の要因が高血圧と有意に関連していた：
   
   1. 年齢：1歳上昇するごとに高血圧のリスクが1.055倍（95%CI: 1.037-1.073, p<0.001）
   2. 性別：男性は女性と比較して高血圧のリスクが2.061倍（95%CI: 1.302-3.267, p=0.002）
   3. BMI：1単位上昇するごとに高血圧のリスクが1.131倍（95%CI: 1.058-1.210, p<0.001）
   ```

#### 統計解析のコツ

1. **適切な検定方法の選択**
   ```
   以下の条件で適切な検定方法を提案してください：
   - 目的変数：高血圧（あり/なし）
   - 説明変数：年齢（連続値）、性別（2群）、BMI（連続値）
   - 交絡因子の調整が必要
   ```

2. **結果の可視化**
   ```
   オッズ比とその95%信頼区間をフォレストプロットで表示してください。
   - 横軸は対数スケール
   - 有意な変数は赤色
   - 信頼区間は線の太さを調整
   ```

3. **追加解析の提案**
   ```
   年齢と性別の交互作用を検討したいのですが、
   どのような解析を追加すればよいでしょうか？
   ```

このように、Copilot Chatを使うことで：
- 適切な統計手法の選択
- コードの作成と実行
- 結果の解釈と表現
を対話形式で進めることができます。

## チェックポイント

以下の項目を確認してください：

- [ ] 研究デザインを理解し、適切な解析計画を立てられる
- [ ] データの前処理から解析まで実行できる
- [ ] GitHubでバージョン管理ができる
- [ ] 結果を適切にまとめ、レポートを作成できる

## 演習課題

1. サンプルデータを使用して、以下の解析を実施してください：
   - 基本的な記述統計
   - 群間比較
   - 多変量解析
   - 結果の可視化

2. 解析結果をR Markdownでレポートにまとめてください

3. 全ての作業をGitHubで管理してください

## 次のステップ

プロジェクトが完了したら、[次のセクション](../06-presentation/README.md)に進んでください。
